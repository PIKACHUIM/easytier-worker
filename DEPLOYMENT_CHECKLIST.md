# 部署检查清单

在部署 EasyTier 节点管理系统之前，请按照此清单逐项检查。

## 📋 部署前检查

### 1. 环境准备

- [ ] 已安装 Node.js 16+
- [ ] 已安装 npm 或 yarn
- [ ] 已注册 Cloudflare 账户
- [ ] 已安装 Wrangler CLI (`npm install -g wrangler`)
- [ ] 已登录 Cloudflare (`npx wrangler login`)

### 2. 项目配置

- [ ] 已克隆项目代码
- [ ] 已安装项目依赖 (`npm install`)
- [ ] 已创建 D1 数据库
- [ ] 已记录 `database_id`
- [ ] 已生成强随机 JWT 密钥（至少 32 字符）
- [ ] 已配置 `wrangler.jsonc` 文件

### 3. 数据库初始化

- [ ] 已执行 `schema.sql` 初始化数据库
- [ ] 数据库表创建成功（users, nodes, system_settings）
- [ ] 数据库索引创建成功
- [ ] 默认系统设置已插入

### 4. 本地测试

- [ ] 本地开发服务器启动成功 (`npm run dev`)
- [ ] 可以访问首页 (http://localhost:8787)
- [ ] 可以访问初始化页面 (/initialize)
- [ ] 初始化功能正常
- [ ] 登录功能正常
- [ ] 节点管理功能正常

### 5. 邮件服务配置（可选）

- [ ] 已注册 Resend 账户
- [ ] 已创建 API 密钥
- [ ] 已添加并验证域名
- [ ] 已配置 DNS 记录（SPF、DKIM、DMARC）
- [ ] 域名验证通过

## 🚀 部署步骤

### 步骤 1: 最终检查

```bash
# 检查配置文件
cat wrangler.test.jsonc

# 确认以下内容：
# - database_id 正确
# - JWT_SECRET 已设置（强随机密钥）
# - ADMIN_EMAIL 已设置
```

### 步骤 2: 构建项目

```bash
# 安装依赖
npm install

# 检查是否有错误
npm run build
```

### 步骤 3: 部署到 Cloudflare Workers

```bash
# 部署
npm run deploy

# 记录部署后的 URL
# 例如: https://easytier-worker.your-subdomain.workers.dev
```

### 步骤 4: 验证部署

- [ ] 可以访问部署后的 URL
- [ ] 首页正常显示
- [ ] 可以访问 /initialize 页面
- [ ] 静态资源加载正常

### 步骤 5: 初始化生产环境

```bash
# 访问初始化页面
# https://your-domain.workers.dev/initialize

# 填写以下信息：
# - JWT 密钥（来自 wrangler.test.jsonc）
# - 超级管理员邮箱
# - 超级管理员密码（强密码）
```

- [ ] 初始化成功
- [ ] 可以使用超级管理员账户登录
- [ ] 仪表板正常显示

### 步骤 6: 配置系统设置

```bash
# 登录后访问系统设置页面
# https://your-domain.workers.dev/settings
```

- [ ] 已配置 Resend API 密钥
- [ ] 已配置发件人邮箱
- [ ] 已配置发件域名
- [ ] 已配置网站名称
- [ ] 已配置网站 URL
- [ ] 设置保存成功

### 步骤 7: 测试功能

**用户注册和登录：**
- [ ] 可以注册新用户
- [ ] 收到验证邮件（如果配置了 Resend）
- [ ] 可以验证邮箱
- [ ] 可以登录

**节点管理：**
- [ ] 可以添加节点
- [ ] 可以编辑节点
- [ ] 可以删除节点
- [ ] 节点列表正常显示

**节点上报：**
- [ ] 使用 `node_reporter.py` 测试上报
- [ ] 上报成功
- [ ] 节点状态更新

**客户端查询：**
- [ ] 使用 `client_query.py` 测试查询
- [ ] 查询成功
- [ ] 返回正确的节点信息

**用户管理：**
- [ ] 可以查看用户列表
- [ ] 可以授予管理员权限
- [ ] 可以撤销管理员权限
- [ ] 可以删除用户

## 🔒 安全检查

### 密钥和密码

- [ ] JWT 密钥足够强（至少 32 字符）
- [ ] JWT 密钥未泄露
- [ ] 超级管理员密码足够强（至少 12 字符）
- [ ] Resend API 密钥未泄露
- [ ] 所有密钥已妥善保管

### 权限配置

- [ ] 超级管理员账户正常
- [ ] 普通用户无法访问管理功能
- [ ] 权限控制正常工作

### 数据安全

- [ ] 数据库访问受限
- [ ] API 认证正常工作
- [ ] HTTPS 已启用

## 📊 性能检查

- [ ] 首页加载时间 < 2 秒
- [ ] API 响应时间 < 500ms
- [ ] 数据库查询优化
- [ ] 静态资源缓存配置

## 🔧 配置优化

### Cloudflare Workers 设置

- [ ] 已设置自定义域名（可选）
- [ ] 已配置 DNS 记录
- [ ] 已启用 HTTPS
- [ ] 已配置 CORS（如需要）

### 数据库优化

- [ ] 已创建必要的索引
- [ ] 已测试查询性能
- [ ] 已设置数据备份计划

## 📝 文档准备

- [ ] 已准备用户使用文档
- [ ] 已准备 API 文档
- [ ] 已准备节点上报脚本
- [ ] 已准备客户端查询脚本

## 🎯 上线后任务

### 立即执行

- [ ] 修改超级管理员密码（如果使用了简单密码）
- [ ] 测试邮件发送功能
- [ ] 添加第一个节点
- [ ] 测试节点上报
- [ ] 测试客户端查询

### 24 小时内

- [ ] 监控系统日志
- [ ] 检查错误率
- [ ] 验证所有功能正常
- [ ] 备份数据库

### 一周内

- [ ] 收集用户反馈
- [ ] 优化性能瓶颈
- [ ] 完善文档
- [ ] 添加监控告警

## 🚨 回滚计划

如果部署出现问题，按以下步骤回滚：

### 1. 回滚代码

```bash
# 回滚到上一个版本
npx wrangler rollback
```

### 2. 恢复数据库

```bash
# 从备份恢复
npx wrangler d1 execute easytier-db --file=backup.sql
```

### 3. 验证回滚

- [ ] 系统可以正常访问
- [ ] 数据完整性检查
- [ ] 功能正常工作

## 📞 紧急联系

如果遇到问题，请联系：

- **技术支持**: your-email@example.com
- **Cloudflare 支持**: https://dash.cloudflare.com/
- **项目 Issues**: https://github.com/yourusername/easytier-worker/issues

## ✅ 部署完成确认

完成以上所有检查后，在此签名确认：

- **部署人员**: _______________
- **部署日期**: _______________
- **部署环境**: _______________
- **部署版本**: v2.0.0
- **部署 URL**: _______________

---

**注意事项：**

1. 请按顺序完成所有检查项
2. 遇到问题及时记录和解决
3. 保存好所有密钥和配置
4. 定期备份数据库
5. 监控系统运行状态

**祝部署顺利！** 🎉