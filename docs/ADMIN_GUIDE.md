# 管理员使用指南

本文档详细说明了 EasyTier 节点管理系统的管理员功能和使用方法。

## 目录

- [权限系统](#权限系统)
- [访问管理面板](#访问管理面板)
- [管理员功能](#管理员功能)
- [系统设置](#系统设置)
- [用户管理](#用户管理)
- [常见问题](#常见问题)

---

## 权限系统

系统采用三级权限管理：

### 1. 超级管理员 (Super Admin)
- **创建方式**：通过系统初始化页面创建
- **权限**：
  - 拥有所有系统权限
  - 可以查看和管理所有节点
  - 可以修改系统设置
  - 可以管理所有用户
  - 可以授予/撤销其他用户的管理员权限
  - 可以删除其他用户
- **特殊保护**：
  - 超级管理员身份永久有效，无法被撤销
  - 超级管理员账户无法被删除
  - 只能有一个超级管理员（首次初始化创建）

### 2. 普通管理员 (Admin)
- **创建方式**：由超级管理员授予
- **权限**：
  - 可以查看所有节点
  - 可以修改系统设置
  - **不能**管理用户（查看、授权、删除）
- **限制**：
  - 可以被超级管理员撤销权限
  - 可以被超级管理员删除

### 3. 普通用户 (User)
- **创建方式**：通过注册页面注册
- **权限**：
  - 只能查看和管理自己的节点
  - 无法访问管理面板
  - 无法访问系统设置

---

## 访问管理面板

### 在首页访问

1. **未登录状态**：
   - 首页导航栏显示：`登录` | `注册`
   - 无法看到管理面板入口

2. **普通用户登录后**：
   - 首页导航栏显示：`我的节点` | `退出`
   - 无法看到管理面板入口

3. **管理员登录后**：
   - 首页导航栏显示：`我的节点` | `管理面板` | `系统设置` | `退出`
   - `管理面板` 按钮带有黄色高亮标识
   - `系统设置` 按钮带有绿色高亮标识

### 在"我的节点"页面访问

1. **普通用户**：
   - 导航栏显示：`首页` | `退出`
   - 无法看到管理面板入口

2. **管理员**：
   - 导航栏显示：`首页` | `管理面板` | `系统设置` | `退出`
   - 可以快速切换到管理功能

### 直接访问

- **管理面板 URL**：`https://your-domain.com/admin`
- **系统设置 URL**：`https://your-domain.com/settings`

**权限检查**：
- 如果未登录，会自动跳转到登录页面
- 如果是普通用户，会显示"需要管理员权限"并跳转到"我的节点"页面
- 只有管理员和超级管理员可以访问

---

## 管理员功能

### 1. 查看所有节点

在管理面板 (`/admin`) 中，可以：

- **查看所有用户的节点**
  - 节点名称
  - 所有者邮箱
  - 地域信息
  - 带宽使用情况
  - 流量使用情况（包括修正流量）
  - 连接数
  - 创建时间
  - 有效期
  - 最后上报时间
  - 在线状态

- **节点操作**
  - 查看节点详细信息
  - 监控节点运行状态

- **自动刷新**
  - 页面每 30 秒自动刷新一次数据
  - 实时监控节点状态

### 2. 节点筛选和排序

管理面板提供了强大的节点管理功能：

- 按所有者筛选
- 按地域筛选
- 按状态筛选（在线/离线）
- 按流量使用情况排序
- 按带宽使用情况排序

---

## 系统设置

访问系统设置页面 (`/settings`)，可以配置：

### 1. 邮件服务配置 (Resend)

**为什么需要配置？**
- 用于发送用户注册验证邮件
- 用于发送密码重置邮件（未来功能）
- 用于发送系统通知邮件

**配置步骤**：

1. **获取 Resend API 密钥**
   - 访问 [Resend 控制台](https://resend.com/api-keys)
   - 创建新的 API 密钥
   - 复制密钥（格式：`re_xxxxxxxxxx`）

2. **配置发件域名**
   - 在 Resend 控制台添加并验证您的域名
   - 例如：`yourdomain.com`
   - 按照 Resend 提供的 DNS 记录进行验证

3. **设置发件人邮箱**
   - 使用已验证域名的邮箱
   - 例如：`noreply@yourdomain.com`
   - 格式：`name@your-verified-domain.com`

4. **在系统设置中填写**
   ```
   Resend API 密钥: re_xxxxxxxxxx
   发件人邮箱: noreply@yourdomain.com
   发件域名: yourdomain.com
   ```

5. **保存设置**
   - 点击"保存设置"按钮
   - 系统会立即应用新配置

### 2. 网站配置

**网站名称**：
- 显示在邮件和页面标题中
- 例如：`EasyTier 节点管理系统`

**网站 URL**：
- 用于生成邮件中的链接
- 必须是完整的 URL
- 例如：`https://easytier.yourdomain.com`

### 3. 配置存储

- 所有配置存储在 D1 数据库中
- 修改后立即生效，无需重新部署
- 配置对所有用户生效

---

## 用户管理

**注意**：只有**超级管理员**可以管理用户，普通管理员无此权限。

### 1. 查看用户列表

在系统设置页面的"用户管理"部分，可以看到：

| 邮箱 | 管理员 | 超级管理员 | 已验证 | 注册时间 | 操作 |
|------|--------|------------|--------|----------|------|
| user@example.com | 否 | 否 | 是 | 2025-01-01 | 设为管理员 / 删除 |
| admin@example.com | 是 | 否 | 是 | 2025-01-01 | 撤销管理员 / 删除 |
| super@example.com | 是 | 是 | 是 | 2025-01-01 | - |

### 2. 授予管理员权限

**操作步骤**：
1. 在用户列表中找到目标用户
2. 点击"设为管理员"按钮
3. 确认操作
4. 用户立即获得管理员权限

**效果**：
- 用户可以访问管理面板
- 用户可以查看所有节点
- 用户可以修改系统设置
- 用户**不能**管理其他用户

### 3. 撤销管理员权限

**操作步骤**：
1. 在用户列表中找到目标管理员
2. 点击"撤销管理员"按钮
3. 确认操作
4. 用户立即失去管理员权限

**限制**：
- 无法撤销超级管理员的权限
- 超级管理员行显示"-"，无操作按钮

### 4. 删除用户

**操作步骤**：
1. 在用户列表中找到目标用户
2. 点击"删除"按钮
3. 确认操作（会有二次确认提示）
4. 用户及其所有节点被删除

**警告**：
- 删除操作**不可恢复**
- 会同时删除该用户的**所有节点**
- 无法删除超级管理员

**确认提示**：
```
确定要删除用户 user@example.com 吗？
此操作将同时删除该用户的所有节点，且不可恢复！
```

---

## 常见问题

### Q1: 如何成为超级管理员？

**A**: 超级管理员只能通过系统初始化创建：

1. 首次部署系统后，访问 `/initialize` 页面
2. 输入环境变量中配置的 JWT 密钥
3. 创建超级管理员账户
4. 系统只能初始化一次

### Q2: 忘记超级管理员密码怎么办？

**A**: 需要通过数据库直接修改：

```sql
-- 生成新密码的 bcrypt 哈希
-- 使用在线工具或命令行生成

-- 更新密码
UPDATE users 
SET password_hash = '新的bcrypt哈希' 
WHERE is_super_admin = 1;
```

### Q3: 可以有多个超级管理员吗？

**A**: 不可以。系统设计为只有一个超级管理员，以确保权限管理的安全性。

### Q4: 普通管理员和超级管理员的区别？

**A**: 主要区别：

| 功能 | 超级管理员 | 普通管理员 |
|------|-----------|-----------|
| 查看所有节点 | ✅ | ✅ |
| 修改系统设置 | ✅ | ✅ |
| 查看用户列表 | ✅ | ❌ |
| 授予/撤销管理员 | ✅ | ❌ |
| 删除用户 | ✅ | ❌ |
| 被撤销权限 | ❌ | ✅ |
| 被删除 | ❌ | ✅ |

### Q5: 为什么我看不到管理面板入口？

**A**: 可能的原因：

1. **未登录**：请先登录
2. **不是管理员**：只有管理员才能看到
3. **浏览器缓存**：清除缓存或强制刷新（Ctrl+F5）
4. **Token 过期**：重新登录

### Q6: 如何检查自己是否是管理员？

**A**: 有几种方法：

1. **查看导航栏**：
   - 如果能看到"管理面板"和"系统设置"链接，说明是管理员

2. **尝试访问**：
   - 直接访问 `/admin` 或 `/settings`
   - 如果能正常访问，说明是管理员
   - 如果被重定向，说明不是管理员

3. **查看浏览器控制台**：
   ```javascript
   // 打开浏览器控制台（F12）
   JSON.parse(localStorage.getItem('user'))
   // 查看 is_admin 或 is_super_admin 字段
   ```

### Q7: 修改系统设置后需要重新部署吗？

**A**: 不需要。所有系统设置存储在数据库中，修改后立即生效。

### Q8: Resend 配置错误会影响用户注册吗？

**A**: 会。如果 Resend 配置错误：
- 用户注册时无法收到验证邮件
- 用户账户会被创建，但 `is_verified` 为 0
- 超级管理员可以在用户管理中手动验证用户

### Q9: 如何批量管理用户？

**A**: 目前系统不支持批量操作。如需批量管理，可以：

1. **通过 API**：使用脚本调用系统 API
2. **通过数据库**：直接操作 D1 数据库

### Q10: 删除用户后可以恢复吗？

**A**: 不可以。删除操作是永久性的，会同时删除：
- 用户账户信息
- 用户的所有节点
- 相关的所有数据

建议在删除前做好数据备份。

---

## 安全建议

### 1. 超级管理员账户安全

- ✅ 使用强密码（至少 12 位，包含大小写字母、数字、特殊字符）
- ✅ 定期更换密码
- ✅ 不要与他人共享超级管理员账户
- ✅ 妥善保管 JWT 密钥

### 2. 管理员权限管理

- ✅ 只授予必要的人员管理员权限
- ✅ 定期审查管理员列表
- ✅ 及时撤销离职人员的权限
- ✅ 记录重要操作日志

### 3. 系统配置安全

- ✅ 不要在公开场合分享 Resend API 密钥
- ✅ 定期检查系统设置
- ✅ 使用 HTTPS 访问管理面板
- ✅ 启用 Cloudflare 的安全功能

### 4. 数据备份

- ✅ 定期备份 D1 数据库
- ✅ 在删除用户前确认数据已备份
- ✅ 测试备份恢复流程

---

## 技术支持

如有问题，请：

1. 查看 [README.md](../README.md) - 项目概述
2. 查看 [API.md](API.md) - API 文档
3. 查看 [INITIALIZATION.md](INITIALIZATION.md) - 初始化指南
4. 提交 Issue 到项目仓库

---

## 更新日志

- **v2.0** (2025-01-04)
  - 添加管理面板入口到首页和"我的节点"页面
  - 优化权限检查逻辑
  - 改进导航菜单样式
  - 添加管理员使用指南

- **v1.0** (2025-01-01)
  - 初始版本
  - 基础管理员功能
  - 系统设置功能
  - 用户管理功能
